<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة برا السالفة</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #121828;
            --secondary-bg: #1a2238;
            --accent-color: #00f7ff;
            --text-color: #f0f8ff;
            --danger-color: #ff3d71;
            --success-color: #00ffab;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding: 15px;
        }

        #game-container {
            width: 100%;
            max-width: 450px;
            background-color: var(--secondary-bg);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 247, 255, 0.2);
            border: 1px solid var(--accent-color);
        }

        .screen { display: none; }
        .screen.active { display: block; }

        h1, h2, h3 {
            color: var(--accent-color);
            margin-bottom: 1rem;
            text-shadow: 0 0 10px var(--accent-color);
        }

        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }
        h3 { font-size: 1.5rem; }

        p { font-size: 1.1rem; line-height: 1.6; margin-bottom: 1.5rem; }

        .button {
            display: inline-block;
            background-color: var(--accent-color);
            color: var(--primary-bg);
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            width: 100%;
            max-width: 300px;
        }

        .button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--accent-color);
        }

        .button.secondary {
            background: transparent;
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
        }

        .button:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .input-group { display: flex; margin-bottom: 1.5rem; gap: 10px; }

        input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--accent-color);
            background-color: var(--primary-bg);
            color: var(--text-color);
            font-size: 1rem;
        }

        .player-list { list-style: none; padding: 0; margin-bottom: 1.5rem; }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary-bg);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .remove-player {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-weight: bold;
        }

        .topic-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .topic-card {
            background-color: var(--primary-bg);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .topic-card.selected {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }

        .topic-card span { font-size: 2.5rem; }

        #game-screen-content {
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .word-display {
            font-size: 2.5rem;
            color: var(--accent-color);
            font-weight: bold;
            margin: 1rem 0;
        }

        .results-list { list-style: none; padding: 0; width: 100%; }
        .results-list li {
            background-color: var(--primary-bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .final-winner {
            color: var(--success-color);
            font-weight: bold;
            text-shadow: 0 0 10px var(--success-color);
        }

        .final-loser {
            color: var(--danger-color);
            font-weight: bold;
            text-shadow: 0 0 10px var(--danger-color);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 100;
        }

        .modal.active { opacity: 1; pointer-events: all; }

        .modal-content {
            background: var(--secondary-bg);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid var(--accent-color);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
        }
        
        /* --- ⭐ تصميم خاص بالروليت --- */
        #roulette-display {
            font-size: 4rem;
            font-weight: bold;
            color: var(--accent-color);
            margin: 2rem 0;
            padding: 1rem;
            min-height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-shadow: 0 0 20px var(--accent-color);
            border: 2px dashed var(--accent-color);
            border-radius: 15px;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="home-screen" class="screen active">
            <h1>🎭<br>برا السالفة</h1>
            <p>لعبة الخداع والاستنتاج... هل تقدر تكشف اللي برا السالفة؟</p>
            <button class="button" data-action="show-screen" data-screen="setup-screen">ابدأ لعبة جديدة</button>
            <button class="button secondary" data-action="show-how-to-play">كيف تلعب؟</button>
        </div>

        <div id="setup-screen" class="screen">
            <h2>إعداد اللعبة</h2>
            <h3>1. اختر الموضوع</h3>
            <div id="topic-selection" class="topic-selection"></div>
            <h3>2. أضف اللاعبين (3 كحد أدنى)</h3>
            <div class="input-group">
                <input type="text" id="player-name-input" placeholder="اكتب اسم اللاعب...">
                <button class="button" id="add-player-btn" style="width: auto;">أضف</button>
            </div>
            <ul id="player-list" class="player-list"></ul>
            <button id="start-game-btn" class="button" disabled>ابدأ اللعبة!</button>
            <button class="button secondary" data-action="show-screen" data-screen="home-screen">رجوع</button>
        </div>

        <div id="game-screen" class="screen">
            <div id="game-screen-content"></div>
        </div>

        <div id="results-screen" class="screen">
            <h2 id="results-title">النتيجة النهائية</h2>
            <div id="results-details"></div>
            <ul id="final-scores" class="results-list"></ul>
            <br>
            <button id="restart-game-btn" class="button">ابدأ جولة جديدة</button>
        </div>
    </div>
    
    <div id="how-to-play-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0;">طريقة اللعب</h2>
            <p><strong>الهدف:</strong> معرفة اللاعب "برا السالفة".</p>
            <ol style="text-align: right; padding-right: 20px;">
                <li style="margin-bottom: 10px;">الجميع (ما عدا واحد) سيحصلون على نفس الكلمة السرية.</li>
                <li style="margin-bottom: 10px;">اللاعب "برا السالفة" لن يعرف الكلمة، ويعرف فقط الموضوع العام.</li>
                <li style="margin-bottom: 10px;">يبدأ كل لاعب بطرح سؤال على اللاعب الذي يليه، ويجب أن تكون الإجابات ذكية بحيث لا تكشف الكلمة ولكن تثبت أنك تعرفها.</li>
                <li style="margin-bottom: 10px;">بعد انتهاء الأسئلة، يصوت الجميع على من يعتقدون أنه "برا السالفة".</li>
                <li style="margin-bottom: 10px;">إذا كشفتم اللاعب الصحيح، يحصل كل من صوت له على نقطة. وإذا فشلتم، يحصل "برا السالفة" على نقطتين!</li>
            </ol>
            <button id="close-how-to-play-btn" class="button">فهمت</button>
        </div>
    </div>

    <div id="roulette-modal" class="modal">
        <div class="modal-content">
            <h2>جاري كشف المشتبه به...</h2>
            <div id="roulette-display"></div>
            <p>من هو برا السالفة؟</p>
        </div>
    </div>

    <audio id="click-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_24915b8e9f.mp3" preload="auto"></audio>
    <audio id="reveal-sound" src="https://cdn.pixabay.com/download/audio/2022/11/22/audio_fb4b370198.mp3" preload="auto"></audio>
    <audio id="success-sound" src="https://cdn.pixabay.com/download/audio/2022/01/18/audio_82c9e7b235.mp3" preload="auto"></audio>
    <audio id="fail-sound" src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c3ffc74f5d.mp3" preload="auto"></audio>
    <audio id="roulette-sound" src="https://cdn.pixabay.com/download/audio/2022/03/13/audio_2c524a737e.mp3" loop preload="auto"></audio>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- حالة اللعبة (Game State) ---
            const gameState = {
                players: [],
                selectedTopic: null,
                secretWord: null,
                outsider: null,
                currentPlayerIndex: 0,
                turn: 0,
                votes: {},
                scores: {},
                gamePhase: 'home',
            };

            // --- قاعدة بيانات الكلمات ---
            const keywords = {
                'طعام': { words: ['بيتزا', 'برجر', 'سوشي', 'كبسة', 'شاورما', 'فلافل', 'منسف', 'كنافة'], icon: '🍕' },
                'سفر': { words: ['مطار', 'جواز سفر', 'فندق', 'شاطئ', 'طائرة', 'تذكرة', 'حقيبة', 'تأشيرة'], icon: '✈️' },
                'أفلام': { words: ['سينما', 'بطل', 'مخرج', 'أكشن', 'كوميديا', 'بوبكورن', 'تذكرة', 'نهاية'], icon: '🎬' },
                'رياضة': { words: ['ملعب', 'هدف', 'كأس', 'حكم', 'جمهور', 'مدرب', 'ماراثون', 'ميدالية'], icon: '⚽️' },
                'حيوانات': { words: ['أسد', 'قطة', 'فيل', 'بطريق', 'زرافة', 'تمساح', 'كنغر', 'بومة'], icon: '🦁' },
                'مهن': { words: ['طبيب', 'مهندس', 'معلم', 'طيار', 'شرطي', 'فنان', 'طباخ', 'مبرمج'], icon: '🧑‍⚕️' },
                'دول': { words: ['مصر', 'السعودية', 'العراق', 'اليابان', 'البرازيل', 'إيطاليا', 'كندا', 'أستراليا'], icon: '🌍' },
                'في المنزل': { words: ['تلفاز', 'سرير', 'ثلاجة', 'أريكة', 'ميكروويف', 'ستائر', 'طاولة', 'مصباح'], icon: '🏠' },
            };

            // --- عناصر الواجهة ---
            const elements = {
                screens: document.querySelectorAll('.screen'),
                playerNameInput: document.getElementById('player-name-input'),
                addPlayerBtn: document.getElementById('add-player-btn'),
                playerList: document.getElementById('player-list'),
                startGameBtn: document.getElementById('start-game-btn'),
                topicSelectionDiv: document.getElementById('topic-selection'),
                gameScreenContent: document.getElementById('game-screen-content'),
                howToPlayModal: document.getElementById('how-to-play-modal'),
                rouletteModal: document.getElementById('roulette-modal'),
                rouletteDisplay: document.getElementById('roulette-display'),
                resultsTitle: document.getElementById('results-title'),
                resultsDetails: document.getElementById('results-details'),
                finalScores: document.getElementById('final-scores'),
            };

            // --- وظائف الصوت ---
            function playSound(soundId) {
                try {
                    const sound = document.getElementById(soundId + '-sound');
                    sound.currentTime = 0;
                    sound.play();
                } catch (e) {
                    console.log(`Could not play sound: ${soundId}`);
                }
            }

            function stopSound(soundId) {
                 try {
                    document.getElementById(soundId + '-sound').pause();
                } catch (e) {
                    console.log(`Could not stop sound: ${soundId}`);
                }
            }
            
            // --- وظائف الواجهة الرئيسية ---
            function showScreen(screenId) {
                elements.screens.forEach(s => s.classList.toggle('active', s.id === screenId));
            }

            function showModal(modalId, show) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.toggle('active', show);
                }
            }

            // --- إعداد اللعبة ---
            function populateTopics() {
                elements.topicSelectionDiv.innerHTML = '';
                for (const topic in keywords) {
                    const card = document.createElement('div');
                    card.className = 'topic-card';
                    card.dataset.topic = topic;
                    card.innerHTML = `<span>${keywords[topic].icon}</span><p>${topic}</p>`;
                    elements.topicSelectionDiv.appendChild(card);
                }
            }

            function selectTopic(topicEl) {
                playSound('click');
                elements.topicSelectionDiv.querySelectorAll('.topic-card').forEach(c => c.classList.remove('selected'));
                topicEl.classList.add('selected');
                gameState.selectedTopic = topicEl.dataset.topic;
                validateSetup();
            }

            function addPlayer() {
                const playerName = elements.playerNameInput.value.trim();
                if (playerName && !gameState.players.includes(playerName)) {
                    playSound('click');
                    gameState.players.push(playerName);
                    if (gameState.scores[playerName] === undefined) {
                        gameState.scores[playerName] = 0;
                    }
                    updatePlayerList();
                    elements.playerNameInput.value = '';
                    elements.playerNameInput.focus();
                }
                validateSetup();
            }

            function removePlayer(playerName) {
                playSound('click');
                gameState.players = gameState.players.filter(p => p !== playerName);
                updatePlayerList();
                validateSetup();
            }

            function updatePlayerList() {
                elements.playerList.innerHTML = '';
                gameState.players.forEach(player => {
                    const li = document.createElement('li');
                    li.className = 'player-item';
                    li.innerHTML = `<span>${player}</span><button class="remove-player" data-player="${player}">X</button>`;
                    elements.playerList.appendChild(li);
                });
            }

            function validateSetup() {
                elements.startGameBtn.disabled = !(gameState.players.length >= 3 && gameState.selectedTopic);
            }

            function startGame() {
                playSound('success');
                const topicWords = keywords[gameState.selectedTopic].words;
                gameState.secretWord = topicWords[Math.floor(Math.random() * topicWords.length)];
                const outsiderIndex = Math.floor(Math.random() * gameState.players.length);
                gameState.outsider = gameState.players[outsiderIndex];
                gameState.votes = {};
                gameState.currentPlayerIndex = 0;
                gameState.gamePhase = 'reveal';
                renderGameScreen();
                showScreen('game-screen');
            }
            
            function restartGame() {
                playSound('click');
                gameState.selectedTopic = null;
                // لا نعيد تصفير النقاط أو اللاعبين لجولة جديدة
                populateTopics();
                validateSetup();
                showScreen('setup-screen');
            }
            
            // --- وظائف عرض مراحل اللعبة ---
            function renderGameScreen() {
                const phase = gameState.gamePhase;
                if (phase === 'reveal') renderRevealPhase();
                else if (phase === 'questions') renderQuestionPhase();
                else if (phase === 'voting') renderVotingPhase();
                else if (phase === 'bonus') renderBonusRoundPhase();
            }

            function renderRevealPhase() {
                const player = gameState.players[gameState.currentPlayerIndex];
                elements.gameScreenContent.innerHTML = `<h2>مرّر الجهاز إلى</h2><h1 style="font-size: 3rem;">${player}</h1><p>عندما تكون جاهزاً، اضغط لكشف دورك.</p><button class="button" data-action="show-role">أنا ${player}، اكشف عن دوري</button>`;
            }
            
            function showPlayerRole() {
                playSound('reveal');
                const player = gameState.players[gameState.currentPlayerIndex];
                let roleHTML = (player === gameState.outsider) ?
                    `<h1>أنت برا السالفة! 🎭</h1><h3>مهمتك: لا تكشف نفسك وحاول معرفة الكلمة السرية.</h3><h4>الموضوع العام هو: ${gameState.selectedTopic}</h4>` :
                    `<h3>الموضوع: ${gameState.selectedTopic}</h3><h1>الكلمة السرية:</h1><div class="word-display">${gameState.secretWord}</div>`;
                elements.gameScreenContent.innerHTML = `${roleHTML}<br><button class="button" data-action="hide-role">فهمت! (إخفاء الشاشة)</button>`;
            }

            function hidePlayerRole() {
                gameState.currentPlayerIndex++;
                if (gameState.currentPlayerIndex < gameState.players.length) {
                    renderRevealPhase();
                } else {
                    gameState.gamePhase = 'questions';
                    gameState.turn = 0;
                    renderGameScreen();
                }
            }

            function renderQuestionPhase() {
                const asker = gameState.players[gameState.turn % gameState.players.length];
                const responder = gameState.players[(gameState.turn + 1) % gameState.players.length];
                elements.gameScreenContent.innerHTML = `<h2>الجولة ${Math.floor(gameState.turn / gameState.players.length) + 1}</h2><h3>حان دور <span style="color:white;">${asker}</span></h3><p>اسأل سؤالاً لـ <span style="color:white;">${responder}</span></p><button class="button" data-action="next-turn">تم السؤال، ننتقل للتالي</button>`;
            }

            function nextTurn() {
                playSound('click');
                gameState.turn++;
                // نكتفي بجولة أسئلة واحدة (كل لاعب يسأل مرة)
                if (gameState.turn >= gameState.players.length) {
                    gameState.gamePhase = 'voting';
                    gameState.currentPlayerIndex = 0;
                    renderGameScreen();
                } else {
                    renderQuestionPhase();
                }
            }

            function renderVotingPhase() {
                const voter = gameState.players[gameState.currentPlayerIndex];
                let optionsHTML = gameState.players
                    .filter(p => p !== voter)
                    .map(p => `<button class="button secondary" data-action="cast-vote" data-vote-for="${p}">${p}</button>`)
                    .join('');
                elements.gameScreenContent.innerHTML = `<h2>حان وقت التصويت!</h2><h3><span style="color:white;">${voter}</span>، من برأيك هو "برا السالفة"؟</h3><div class="button-group">${optionsHTML}</div>`;
            }

            function castVote(votedFor) {
                playSound('click');
                const voter = gameState.players[gameState.currentPlayerIndex];
                gameState.votes[voter] = votedFor;
                gameState.currentPlayerIndex++;
                if (gameState.currentPlayerIndex < gameState.players.length) {
                    elements.gameScreenContent.innerHTML = `<h2>تم تسجيل صوتك بسرية.</h2><p>مرّر الجهاز للاعب التالي.</p><button class="button" data-action="next-voter">التالي</button>`;
                } else {
                    calculateResults();
                }
            }

            function calculateResults() {
                const voteCounts = {};
                gameState.players.forEach(p => voteCounts[p] = 0);

                let correctVoters = [];
                for (const voter in gameState.votes) {
                    const votedFor = gameState.votes[voter];
                    if (votedFor) voteCounts[votedFor]++;
                    if (votedFor === gameState.outsider) {
                        correctVoters.push(voter);
                    }
                }
                
                correctVoters.forEach(p => gameState.scores[p]++);

                let maxVotes = 0, accusedPlayers = [];
                for (const player in voteCounts) {
                    if (voteCounts[player] > maxVotes) {
                        maxVotes = voteCounts[player];
                        accusedPlayers = [player];
                    } else if (voteCounts[player] === maxVotes) {
                        accusedPlayers.push(player);
                    }
                }

                // إذا كان هناك تعادل، نختار واحداً عشوائياً منهم ليكون المتهم الرئيسي
                const accusedPlayer = accusedPlayers[Math.floor(Math.random() * accusedPlayers.length)];
                
                startRevealRoulette(accusedPlayer);
            }

            // --- ⭐ وظيفة الروليت الجديدة ---
            function startRevealRoulette(accusedPlayer) {
                showModal('roulette-modal', true);
                playSound('roulette');
                
                let delay = 75;
                let duration = 3000; // 3 ثواني
                let startTime = Date.now();
                
                const intervalId = setInterval(() => {
                    // اختيار اسم عشوائي للعرض السريع
                    const randomPlayer = gameState.players[Math.floor(Math.random() * gameState.players.length)];
                    elements.rouletteDisplay.textContent = randomPlayer;

                    // إيقاف الروليت بعد انتهاء المدة
                    if (Date.now() - startTime > duration) {
                        clearInterval(intervalId);
                        stopSound('roulette');
                        elements.rouletteDisplay.textContent = accusedPlayer; // عرض المتهم الحقيقي
                        
                        setTimeout(() => {
                           showModal('roulette-modal', false);
                           handleAccusationResult(accusedPlayer);
                        }, 2000); // انتظر ثانيتين بعد الكشف
                    }
                }, delay);
            }

            function handleAccusationResult(accusedPlayer) {
                if (accusedPlayer === gameState.outsider) {
                    playSound('fail'); // صوت فشل لأنه تم كشفه
                    gameState.gamePhase = 'bonus';
                    renderGameScreen();
                } else {
                    playSound('success'); // صوت نجاح لأنه خدعهم
                    gameState.scores[gameState.outsider] += 2;
                    showFinalScores(
                        'لقد خدعهم!',
                        `<p>اللاعب <strong class="final-winner">${gameState.outsider}</strong> نجح في خداع الجميع وحصل على نقطتين!</p><p>تم اتهام ${accusedPlayer} بالخطأ. الكلمة الصحيحة كانت: <strong>${gameState.secretWord}</strong></p>`
                    );
                }
            }
            
            function renderBonusRoundPhase() {
                const options = getBonusOptions();
                const optionsHTML = options.map(opt => `<button class="button secondary" data-action="check-bonus" data-answer="${opt}">${opt}</button>`).join('');

                elements.gameScreenContent.innerHTML = `
                    <h2>تم كشف <span class="final-loser">${gameState.outsider}</span>!</h2>
                    <h3>تحدي أخير له:</h3>
                    <p>هل يمكنك تخمين الكلمة السرية لكسب نقطة شرف؟</p>
                    <div class="button-group">${optionsHTML}</div>
                `;
            }

            function getBonusOptions() {
                const correctWord = gameState.secretWord;
                const allWords = keywords[gameState.selectedTopic].words;
                const distractors = allWords.filter(w => w !== correctWord);
                
                for (let i = distractors.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [distractors[i], distractors[j]] = [distractors[j], distractors[i]];
                }
                
                const finalOptions = distractors.slice(0, 3);
                finalOptions.push(correctWord);
                return finalOptions.sort(() => Math.random() - 0.5);
            }

            function checkBonusAnswer(answer) {
                let title, details;
                if (answer === gameState.secretWord) {
                    playSound('success');
                    gameState.scores[gameState.outsider]++;
                    title = 'تخمين صحيح!';
                    details = `<p>نجح <strong class="final-winner">${gameState.outsider}</strong> في معرفة الكلمة وكسب نقطة شرف.</p>`;
                } else {
                    playSound('fail');
                    title = 'تخمين خاطئ!';
                    details = `<p>للأسف، الكلمة الصحيحة كانت: <strong>${gameState.secretWord}</strong></p>`;
                }
                showFinalScores(title, details);
            }

            function showFinalScores(title, details) {
                showScreen('results-screen');
                elements.resultsTitle.innerText = title;
                elements.resultsDetails.innerHTML = details;
                
                elements.finalScores.innerHTML = '<h3>النقاط الإجمالية:</h3>';
                Object.keys(gameState.scores)
                    .sort((a, b) => gameState.scores[b] - gameState.scores[a])
                    .forEach(player => {
                        const li = document.createElement('li');
                        li.innerText = `${player}: ${gameState.scores[player]} نقطة`;
                        elements.finalScores.appendChild(li);
                });
            }

            // --- إدارة الأحداث (Event Listeners) ---
            document.body.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                if (!action) return;
                
                playSound('click');

                switch(action) {
                    case 'show-screen': showScreen(e.target.dataset.screen); break;
                    case 'show-how-to-play': showModal('how-to-play-modal', true); break;
                    case 'show-role': showPlayerRole(); break;
                    case 'hide-role': hidePlayerRole(); break;
                    case 'next-turn': nextTurn(); break;
                    case 'next-voter': renderVotingPhase(); break;
                    case 'cast-vote': castVote(e.target.dataset.voteFor); break;
                    case 'check-bonus': checkBonusAnswer(e.target.dataset.answer); break;
                }
            });

            elements.addPlayerBtn.addEventListener('click', addPlayer);
            elements.playerNameInput.addEventListener('keypress', (e) => {
                if(e.key === 'Enter') addPlayer();
            });

            elements.startGameBtn.addEventListener('click', startGame);
            document.getElementById('restart-game-btn').addEventListener('click', restartGame);
            document.getElementById('close-how-to-play-btn').addEventListener('click', () => {
                playSound('click');
                showModal('how-to-play-modal', false);
            });

            // Event Delegation for dynamic elements
            elements.topicSelectionDiv.addEventListener('click', (e) => {
                const card = e.target.closest('.topic-card');
                if (card) selectTopic(card);
            });

            elements.playerList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-player')) {
                    removePlayer(e.target.dataset.player);
                }
            });

            // --- بدء تشغيل الواجهة ---
            populateTopics();
            showScreen('home-screen');
        });
    </script>
</body>
</html>
