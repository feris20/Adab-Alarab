<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #121828;
            --secondary-bg: #1a2238;
            --accent-color: #00f7ff;
            --text-color: #f0f8ff;
            --danger-color: #ff3d71;
            --success-color: #00ffab;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding: 15px;
        }

        #game-container {
            width: 100%;
            max-width: 450px;
            background-color: var(--secondary-bg);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 247, 255, 0.2);
            border: 1px solid var(--accent-color);
            overflow: hidden;
        }

        .screen { display: none; }
        .screen.active { display: block; }

        h1, h2, h3 {
            color: var(--accent-color);
            margin-bottom: 1rem;
            text-shadow: 0 0 10px var(--accent-color);
        }

        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }
        h3 { font-size: 1.5rem; }

        p { font-size: 1.1rem; line-height: 1.6; margin-bottom: 1.5rem; }

        .button {
            display: inline-block;
            background-color: var(--accent-color);
            color: var(--primary-bg);
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            width: 100%;
            max-width: 300px;
        }

        .button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--accent-color);
        }

        .button.secondary {
            background: transparent;
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
        }

        .button:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .input-group { display: flex; margin-bottom: 1.5rem; gap: 10px; }

        input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--accent-color);
            background-color: var(--primary-bg);
            color: var(--text-color);
            font-size: 1rem;
        }

        .player-list { list-style: none; padding: 0; margin-bottom: 1.5rem; }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary-bg);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .remove-player {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-weight: bold;
        }

        .topic-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 1.5rem;
        }
        
        #outsider-guess-words {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 1.5rem;
        }

        .topic-card, .word-choice-btn {
            background-color: var(--primary-bg);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .topic-card.selected {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }

        .topic-card span { font-size: 2.5rem; }

        #game-screen-content {
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .word-display {
            font-size: 2.5rem;
            color: var(--accent-color);
            font-weight: bold;
            margin: 1rem 0;
        }

        .results-list { list-style: none; padding: 0; width: 100%; }
        .results-list li {
            background-color: var(--primary-bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .final-winner {
            color: var(--success-color);
            font-weight: bold;
            text-shadow: 0 0 10px var(--success-color);
        }

        .final-loser {
            color: var(--danger-color);
            font-weight: bold;
            text-shadow: 0 0 10px var(--danger-color);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 100;
        }

        .modal.active { opacity: 1; pointer-events: all; }

        .modal-content {
            background: var(--secondary-bg);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid var(--accent-color);
            box-shadow: 0 0 40px rgba(0, 247, 255, 0.4);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
        }
        
        #roulette-display {
            font-size: 3.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin: 2rem 0;
            padding: 1rem;
            min-height: 110px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-shadow: 0 0 20px var(--accent-color);
            border: 2px dashed var(--accent-color);
            border-radius: 15px;
        }

        #reveal-result-message {
            font-size: 1.4rem;
            line-height: 1.7;
            min-height: 100px;
        }

    </style>
</head>
<body>

    <div id="game-container">
        <div id="home-screen" class="screen active">
            <h1>ğŸ­<br>Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©</h1>
            <p>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø®Ø¯Ø§Ø¹ ÙˆØ§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬... Ù‡Ù„ ØªÙ‚Ø¯Ø± ØªÙƒØ´Ù Ø§Ù„Ù„ÙŠ Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©ØŸ</p>
            <button class="button" data-action="show-screen" data-screen="setup-screen">Ø§Ø¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button class="button secondary" data-action="show-how-to-play">ÙƒÙŠÙ ØªÙ„Ø¹Ø¨ØŸ</button>
        </div>

        <div id="setup-screen" class="screen">
            <h2>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
            <h3>1. Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</h3>
            <div id="topic-selection" class="topic-selection"></div>
            <h3>2. Ø£Ø¶Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (3 ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰)</h3>
            <div class="input-group">
                <input type="text" id="player-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨...">
                <button class="button" id="add-player-btn" style="width: auto;">Ø£Ø¶Ù</button>
            </div>
            <ul id="player-list" class="player-list"></ul>
            <button id="start-game-btn" class="button" disabled>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©!</button>
            <button class="button secondary" data-action="show-screen" data-screen="home-screen">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <div id="game-screen" class="screen">
            <div id="game-screen-content"></div>
        </div>
        
        <div id="outsider-guess-screen" class="screen">
            <h2 id="outsider-guess-title"></h2>
            <p>Ù…Ø§ Ù‡ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ© Ø§Ù„ØªÙŠ ÙƒÙ†Øª ØªØ¸Ù† Ø£Ù†Ù‡Ù… ÙŠØªØ­Ø¯Ø«ÙˆÙ† Ø¹Ù†Ù‡Ø§ØŸ</p>
            <div id="outsider-guess-words"></div>
        </div>

        <div id="results-screen" class="screen">
            <h2 id="results-title">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
            <div id="results-details"></div>
            <ul id="final-scores" class="results-list"></ul>
            <br>
            <button id="restart-game-btn" class="button">Ø§Ø¨Ø¯Ø£ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
    </div>
    
    <div id="how-to-play-modal" class="modal">
        <div class="modal-content">
             <h2 style="margin-top:0;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨</h2>
             <p><strong>Ø§Ù„Ù‡Ø¯Ù:</strong> ÙƒØ´Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ "Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©" Ø£Ùˆ Ø®Ø¯Ø§Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£Ù†Øª Ù‡Ùˆ!</p>
             <ol style="text-align: right; padding-right: 20px; line-height: 1.8;">
                 <li>Ø§Ù„Ø¬Ù…ÙŠØ¹ (Ù…Ø§ Ø¹Ø¯Ø§ ÙˆØ§Ø­Ø¯) Ø³ÙŠØ­ØµÙ„ÙˆÙ† Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©.</li>
                 <li>Ø§Ù„Ù„Ø§Ø¹Ø¨ "Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©" Ù„Ù† ÙŠØ¹Ø±Ù Ø§Ù„ÙƒÙ„Ù…Ø©ØŒ ÙˆÙŠØ¹Ø±Ù ÙÙ‚Ø· Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø¹Ø§Ù….</li>
                 <li>ÙŠØªÙ†Ø§ÙˆØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø¨Ø·Ø±Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø°ÙƒØ§Ø¡.</li>
                 <li>Ø¨Ø¹Ø¯ Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©ØŒ ÙŠØµÙˆØª Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¹Ù„Ù‰ Ù…Ù† ÙŠØ¹ØªÙ‚Ø¯ÙˆÙ† Ø£Ù†Ù‡ "Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©".</li>
                 <li>**Ø§Ù„Ù†Ù‚Ø§Ø·:**
                    <ul style="padding-right: 20px; margin-top: 5px;">
                        <li>Ø¥Ø°Ø§ ÙƒØ´ÙØªÙ… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØµØ­ÙŠØ­: ÙƒÙ„ Ù…Ù† ØµÙˆÙ‘Øª Ù„Ù‡ ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø·ØªÙŠÙ†.</li>
                        <li>Ø¥Ø°Ø§ ÙØ´Ù„ØªÙ…: Ø§Ù„Ù„Ø§Ø¹Ø¨ "Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©" ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ 3 Ù†Ù‚Ø§Ø·.</li>
                    </ul>
                 </li>
                <li>**ØªØ­Ø¯ÙŠ "Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©":** Ø¨Ø¹Ø¯ ÙƒØ´ÙÙ‡ØŒ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙ‡ ØªØ®Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©. Ø¥Ø°Ø§ Ø£Ø®Ø·Ø£ØŒ ÙŠÙØ®ØµÙ… Ù…Ù†Ù‡ Ù†Ù‚Ø·Ø©.</li>
             </ol>
             <button id="close-how-to-play-btn" class="button">ÙÙ‡Ù…Øª</button>
        </div>
    </div>

    <div id="roulette-modal" class="modal">
        <div class="modal-content">
            <h2>Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©...</h2>
            <div id="roulette-display"></div>
            <div id="reveal-result-message"></div>
        </div>
    </div>

    <audio id="click-sound" src="mixkit-select-click-1109.wav" preload="auto"></audio>
    <audio id="reveal-sound" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/105586/ui_aud_swoosh.mp3" preload="auto"></audio>
    <audio id="success-sound" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/105586/ui_aud_notification.mp3" preload="auto"></audio>
    <audio id="fail-sound" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/105586/ui_aud_error.mp3" preload="auto"></audio>
    <audio id="roulette-sound" src="https://github.com/universome/fcc-drum-machine/blob/master/src/assets/sounds/fast-typing.mp3?raw=true" loop preload="auto"></audio>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const gameState = {
                players: [], selectedTopic: null, secretWord: null, outsider: null,
                currentPlayerIndex: 0, votes: {}, scores: {}, accusedPlayer: null,
            };

            const keywords = {
                'Ø·Ø¹Ø§Ù…': { words: ['Ø¨ÙŠØªØ²Ø§', 'Ø¨Ø±Ø¬Ø±', 'Ø³ÙˆØ´ÙŠ', 'ÙƒØ¨Ø³Ø©', 'Ø´Ø§ÙˆØ±Ù…Ø§', 'ÙÙ„Ø§ÙÙ„', 'Ù…Ù†Ø³Ù', 'ÙƒÙ†Ø§ÙØ©'], icon: 'ğŸ•' },
                'Ø³ÙØ±': { words: ['Ù…Ø·Ø§Ø±', 'Ø¬ÙˆØ§Ø² Ø³ÙØ±', 'ÙÙ†Ø¯Ù‚', 'Ø´Ø§Ø·Ø¦', 'Ø·Ø§Ø¦Ø±Ø©', 'ØªØ°ÙƒØ±Ø©', 'Ø­Ù‚ÙŠØ¨Ø©', 'ØªØ£Ø´ÙŠØ±Ø©'], icon: 'âœˆï¸' },
                'Ø£ÙÙ„Ø§Ù…': { words: ['Ø³ÙŠÙ†Ù…Ø§', 'Ø¨Ø·Ù„', 'Ù…Ø®Ø±Ø¬', 'Ø£ÙƒØ´Ù†', 'ÙƒÙˆÙ…ÙŠØ¯ÙŠØ§', 'Ø¨ÙˆØ¨ÙƒÙˆØ±Ù†', 'ØªØ°ÙƒØ±Ø©', 'Ù†Ù‡Ø§ÙŠØ©'], icon: 'ğŸ¬' },
                'Ø±ÙŠØ§Ø¶Ø©': { words: ['Ù…Ù„Ø¹Ø¨', 'Ù‡Ø¯Ù', 'ÙƒØ£Ø³', 'Ø­ÙƒÙ…', 'Ø¬Ù…Ù‡ÙˆØ±', 'Ù…Ø¯Ø±Ø¨', 'Ù…Ø§Ø±Ø§Ø«ÙˆÙ†', 'Ù…ÙŠØ¯Ø§Ù„ÙŠØ©'], icon: 'âš½ï¸' },
                'Ø­ÙŠÙˆØ§Ù†Ø§Øª': { words: ['Ø£Ø³Ø¯', 'Ù‚Ø·Ø©', 'ÙÙŠÙ„', 'Ø¨Ø·Ø±ÙŠÙ‚', 'Ø²Ø±Ø§ÙØ©', 'ØªÙ…Ø³Ø§Ø­', 'ÙƒÙ†ØºØ±', 'Ø¨ÙˆÙ…Ø©'], icon: 'ğŸ¦' },
                'Ù…Ù‡Ù†': { words: ['Ø·Ø¨ÙŠØ¨', 'Ù…Ù‡Ù†Ø¯Ø³', 'Ù…Ø¹Ù„Ù…', 'Ø·ÙŠØ§Ø±', 'Ø´Ø±Ø·ÙŠ', 'ÙÙ†Ø§Ù†', 'Ø·Ø¨Ø§Ø®', 'Ù…Ø¨Ø±Ù…Ø¬'], icon: 'ğŸ§‘â€âš•ï¸' },
                'Ø¯ÙˆÙ„': { words: ['Ù…ØµØ±', 'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', 'Ø§Ù„Ø¹Ø±Ø§Ù‚', 'Ø§Ù„ÙŠØ§Ø¨Ø§Ù†', 'Ø§Ù„Ø¨Ø±Ø§Ø²ÙŠÙ„', 'Ø¥ÙŠØ·Ø§Ù„ÙŠØ§', 'ÙƒÙ†Ø¯Ø§', 'Ø£Ø³ØªØ±Ø§Ù„ÙŠØ§'], icon: 'ğŸŒ' },
                'ÙÙŠ Ø§Ù„Ù…Ù†Ø²Ù„': { words: ['ØªÙ„ÙØ§Ø²', 'Ø³Ø±ÙŠØ±', 'Ø«Ù„Ø§Ø¬Ø©', 'Ø£Ø±ÙŠÙƒØ©', 'Ù…ÙŠÙƒØ±ÙˆÙˆÙŠÙ', 'Ø³ØªØ§Ø¦Ø±', 'Ø·Ø§ÙˆÙ„Ø©', 'Ù…ØµØ¨Ø§Ø­'], icon: 'ğŸ ' },
            };

            const elements = {
                screens: document.querySelectorAll('.screen'),
                playerNameInput: document.getElementById('player-name-input'),
                addPlayerBtn: document.getElementById('add-player-btn'),
                playerList: document.getElementById('player-list'),
                startGameBtn: document.getElementById('start-game-btn'),
                topicSelectionDiv: document.getElementById('topic-selection'),
                gameScreenContent: document.getElementById('game-screen-content'),
                rouletteModal: document.getElementById('roulette-modal'),
                rouletteDisplay: document.getElementById('roulette-display'),
                revealResultMessage: document.getElementById('reveal-result-message'),
                resultsTitle: document.getElementById('results-title'),
                resultsDetails: document.getElementById('results-details'),
                finalScores: document.getElementById('final-scores'),
                outsiderGuessScreen: document.getElementById('outsider-guess-screen'),
                outsiderGuessTitle: document.getElementById('outsider-guess-title'),
                outsiderGuessWords: document.getElementById('outsider-guess-words'),
                restartGameBtn: document.getElementById('restart-game-btn'),
            };

            // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØµÙˆØª ---
            function playSound(soundId) {
                try {
                    const sound = document.getElementById(`${soundId}-sound`);
                    sound.currentTime = 0;
                    sound.play();
                } catch (e) { console.error(`Could not play sound: ${soundId}`, e); }
            }

            function stopSound(soundId) {
                 try {
                    const sound = document.getElementById(`${soundId}-sound`);
                    sound.pause();
                } catch (e) { console.error(`Could not stop sound: ${soundId}`, e); }
            }
            
            // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
            function showScreen(screenId) {
                elements.screens.forEach(s => s.classList.toggle('active', s.id === screenId));
            }

            function showModal(modalId, show) {
                document.getElementById(modalId).classList.toggle('active', show);
            }

            // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø© ---
            function populateTopics() {
                elements.topicSelectionDiv.innerHTML = '';
                for (const topic in keywords) {
                    const card = document.createElement('div');
                    card.className = 'topic-card';
                    card.dataset.topic = topic;
                    card.innerHTML = `<span>${keywords[topic].icon}</span><p>${topic}</p>`;
                    elements.topicSelectionDiv.appendChild(card);
                }
            }

            function addPlayer() {
                const playerName = elements.playerNameInput.value.trim();
                if (playerName && !gameState.players.includes(playerName)) {
                    playSound('click');
                    gameState.players.push(playerName);
                    if (gameState.scores[playerName] === undefined) gameState.scores[playerName] = 0;
                    updatePlayerList();
                    elements.playerNameInput.value = '';
                    elements.playerNameInput.focus();
                }
                validateSetup();
            }

            function removePlayer(playerName) {
                playSound('click');
                gameState.players = gameState.players.filter(p => p !== playerName);
                delete gameState.scores[playerName];
                updatePlayerList();
                validateSetup();
            }

            function updatePlayerList() {
                elements.playerList.innerHTML = '';
                gameState.players.forEach(player => {
                    const li = document.createElement('li');
                    li.className = 'player-item';
                    li.innerHTML = `<span>${player}</span><button class="remove-player" data-player="${player}">X</button>`;
                    elements.playerList.appendChild(li);
                });
            }
            
            function validateSetup() {
                elements.startGameBtn.disabled = !(gameState.players.length >= 3 && gameState.selectedTopic);
            }

            function startGame() {
                playSound('success');
                const topicWords = keywords[gameState.selectedTopic].words;
                gameState.secretWord = topicWords[Math.floor(Math.random() * topicWords.length)];
                const outsiderIndex = Math.floor(Math.random() * gameState.players.length);
                gameState.outsider = gameState.players[outsiderIndex];
                gameState.votes = {};
                gameState.currentPlayerIndex = 0;
                renderScreen('game-screen-content', 'reveal');
                showScreen('game-screen');
            }

            // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„ØªØµÙˆÙŠØª ---
            function renderScreen(containerId, phase, data = {}) {
                const container = document.getElementById(containerId);
                let html = '';
                switch(phase) {
                    case 'reveal':
                        const player = gameState.players[gameState.currentPlayerIndex];
                        html = `<h2>Ù…Ø±Ù‘Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¥Ù„Ù‰</h2><h1 style="font-size: 3rem;">${player}</h1><p>Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ø§Ù‹ØŒ Ø§Ø¶ØºØ· Ù„ÙƒØ´Ù Ø¯ÙˆØ±Ùƒ.</p><button class="button" data-action="show-role">Ø£Ù†Ø§ ${player}ØŒ Ø§ÙƒØ´Ù Ø¹Ù† Ø¯ÙˆØ±ÙŠ</button>`;
                        break;
                    case 'show-role':
                        const isOutsider = gameState.players[gameState.currentPlayerIndex] === gameState.outsider;
                        const roleHTML = isOutsider ?
                            `<h1>Ø£Ù†Øª Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©! ğŸ­</h1><h3>Ù…Ù‡Ù…ØªÙƒ: Ù„Ø§ ØªÙƒØ´Ù Ù†ÙØ³Ùƒ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¹Ø±ÙØ© Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©.</h3><h4>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø¹Ø§Ù… Ù‡Ùˆ: ${gameState.selectedTopic}</h4>` :
                            `<h3>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ${gameState.selectedTopic}</h3><h1>Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©:</h1><div class="word-display">${gameState.secretWord}</div>`;
                        html = `${roleHTML}<br><button class="button" data-action="hide-role">ÙÙ‡Ù…Øª! (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©)</button>`;
                        break;
                    case 'questions':
                        let turn = gameState.currentPlayerIndex;
                        const asker = gameState.players[turn % gameState.players.length];
                        const responder = gameState.players[(turn + 1) % gameState.players.length];
                        html = `<h2>Ø§Ù„Ø¬ÙˆÙ„Ø© ${turn + 1}</h2><h3>Ø­Ø§Ù† Ø¯ÙˆØ± <span style="color:white;">${asker}</span></h3><p>Ø§Ø³Ø£Ù„ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ù„Ù€ <span style="color:white;">${responder}</span></p><button class="button" data-action="next-turn">ØªÙ… Ø§Ù„Ø³Ø¤Ø§Ù„ØŒ Ù†Ù†ØªÙ‚Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ</button>`;
                        break;
                    case 'voting':
                        const voter = gameState.players[gameState.currentPlayerIndex];
                        const optionsHTML = gameState.players
                            .filter(p => p !== voter)
                            .map(p => `<button class="button secondary" data-action="cast-vote" data-vote-for="${p}">${p}</button>`)
                            .join('');
                        html = `<h2>Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„ØªØµÙˆÙŠØª!</h2><h3><span style="color:white;">${voter}</span>ØŒ Ù…Ù† Ø¨Ø±Ø£ÙŠÙƒ Ù‡Ùˆ "Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©"ØŸ</h3><div class="button-group">${optionsHTML}</div>`;
                        break;
                    case 'pass-device':
                        html = `<h2>ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙƒ Ø¨Ø³Ø±ÙŠØ©.</h2><p>Ù…Ø±Ù‘Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ.</p><button class="button" data-action="next-voter">Ø§Ù„ØªØ§Ù„ÙŠ</button>`;
                        break;
                }
                container.innerHTML = html;
            }
            
            function handleAction(e) {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                
                const action = target.dataset.action;
                // Play click for most actions, but not for reveal
                if (action !== 'show-role') playSound('click');
                
                switch(action) {
                    case 'show-screen': showScreen(target.dataset.screen); break;
                    case 'show-how-to-play': showModal('how-to-play-modal', true); break;
                    case 'show-role': playSound('reveal'); renderScreen('game-screen-content', 'show-role'); break;
                    case 'hide-role':
                        gameState.currentPlayerIndex++;
                        if (gameState.currentPlayerIndex < gameState.players.length) {
                           renderScreen('game-screen-content', 'reveal');
                        } else {
                           gameState.currentPlayerIndex = 0; // Reset for question phase
                           renderScreen('game-screen-content', 'questions');
                        }
                        break;
                    case 'next-turn':
                        gameState.currentPlayerIndex++;
                        if (gameState.currentPlayerIndex < gameState.players.length) {
                            renderScreen('game-screen-content', 'questions');
                        } else {
                           gameState.currentPlayerIndex = 0; // Reset for voting phase
                           renderScreen('game-screen-content', 'voting');
                        }
                        break;
                    case 'cast-vote':
                        const voter = gameState.players[gameState.currentPlayerIndex];
                        gameState.votes[voter] = target.dataset.voteFor;
                        gameState.currentPlayerIndex++;
                        if (gameState.currentPlayerIndex < gameState.players.length) {
                            renderScreen('game-screen-content', 'pass-device');
                        } else {
                            processVotesAndReveal();
                        }
                        break;
                    case 'next-voter':
                        renderScreen('game-screen-content', 'voting');
                        break;
                    case 'check-outsider-guess':
                        checkOutsiderGuess(target.dataset.word);
                        break;
                }
            }
            
            function processVotesAndReveal() {
                // 1. Calculate votes and assign initial points
                const voteCounts = gameState.players.reduce((acc, p) => ({ ...acc, [p]: 0 }), {});
                Object.values(gameState.votes).forEach(votedFor => {
                    if (voteCounts[votedFor] !== undefined) voteCounts[votedFor]++;
                });

                let maxVotes = 0;
                gameState.accusedPlayer = null;
                for (const player in voteCounts) {
                    if (voteCounts[player] > maxVotes) {
                        maxVotes = voteCounts[player];
                        gameState.accusedPlayer = player;
                    }
                }
                
                const groupGuessedCorrectly = gameState.accusedPlayer === gameState.outsider;

                if (groupGuessedCorrectly) {
                    playSound('success');
                    gameState.players.forEach(p => {
                        if (gameState.votes[p] === gameState.outsider) {
                            gameState.scores[p] += 2; // +2 points for correct guess
                        }
                    });
                } else {
                    playSound('fail');
                    gameState.scores[gameState.outsider] += 3; // +3 points for fooling them
                }

                // 2. Start the roulette to reveal the TRUE outsider
                startRevealRoulette(groupGuessedCorrectly);
            }
            
            function startRevealRoulette(groupGuessedCorrectly) {
                showModal('roulette-modal', true);
                elements.revealResultMessage.innerHTML = ''; // Clear previous message
                playSound('roulette');
                
                const duration = 3500; // 3.5 seconds
                const startTime = Date.now();
                
                const intervalId = setInterval(() => {
                    const randomPlayer = gameState.players[Math.floor(Math.random() * gameState.players.length)];
                    elements.rouletteDisplay.textContent = randomPlayer;

                    if (Date.now() - startTime > duration) {
                        clearInterval(intervalId);
                        stopSound('roulette');
                        elements.rouletteDisplay.textContent = gameState.outsider; // Reveal the true outsider
                        
                        let message = '';
                        if (groupGuessedCorrectly) {
                            message = `<p><strong class="final-winner">Ù„Ù‚Ø¯ ÙƒØ´ÙØªÙ…ÙˆÙ‡!</strong></p><p>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ù†Ø¬Ø­ÙˆØ§ ÙÙŠ ÙƒØ´Ù Ø£Ù† <strong class="final-loser">${gameState.outsider}</strong> Ù‡Ùˆ Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©.</p>`;
                        } else {
                            message = `<p><strong class="final-loser">Ù„Ù‚Ø¯ Ø®Ø¯Ø¹ÙƒÙ…!</strong></p><p>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø§ØªÙ‡Ù…ÙˆØ§ <strong style="color: white;">${gameState.accusedPlayer || 'Ù„Ø§ Ø£Ø­Ø¯'}</strong>ØŒ Ù„ÙƒÙ† <strong class="final-winner">${gameState.outsider}</strong> Ù‡Ùˆ Ù…Ù† ÙƒØ§Ù† Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©!</p>`;
                        }
                        elements.revealResultMessage.innerHTML = message;
                        
                        setTimeout(() => {
                           showModal('roulette-modal', false);
                           renderOutsiderGuessPhase();
                        }, 4000); // Wait 4 seconds to read the result
                    }
                }, 80);
            }

            function renderOutsiderGuessPhase() {
                showScreen('outsider-guess-screen');
                elements.outsiderGuessTitle.innerHTML = `ÙŠØ§ <span class="final-loser">${gameState.outsider}</span>ØŒ Ù‡Ø°Ø§ ØªØ­Ø¯ÙŠÙƒ!`;
                
                const words = keywords[gameState.selectedTopic].words;
                elements.outsiderGuessWords.innerHTML = words.map(word => 
                    `<button class="button secondary word-choice-btn" data-action="check-outsider-guess" data-word="${word}">${word}</button>`
                ).join('');
            }

            function checkOutsiderGuess(guessedWord) {
                let title, details;
                if (guessedWord === gameState.secretWord) {
                    playSound('success');
                    title = 'ØªØ®Ù…ÙŠÙ† ØµØ­ÙŠØ­!';
                    details = `<p><strong class="final-winner">${gameState.outsider}</strong> Ù†Ø¬Ø­ ÙÙŠ ØªØ®Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ© ÙˆÙ†Ø¬Ø§ Ø¨Ù†Ù‚Ø§Ø·Ù‡!</p>`;
                } else {
                    playSound('fail');
                    gameState.scores[gameState.outsider]--; // Deduct 1 point
                    title = 'ØªØ®Ù…ÙŠÙ† Ø®Ø§Ø·Ø¦!';
                    details = `<p>Ù„Ù„Ø£Ø³Ù ÙŠØ§ <strong class="final-loser">${gameState.outsider}</strong>ØŒ Ù„Ù‚Ø¯ Ø®Ø³Ø±Øª Ù†Ù‚Ø·Ø©. Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙƒØ§Ù†Øª: <strong>${gameState.secretWord}</strong></p>`;
                }
                showFinalScores(title, details);
            }

            function showFinalScores(title, details) {
                showScreen('results-screen');
                elements.resultsTitle.innerText = title;
                elements.resultsDetails.innerHTML = details;
                
                elements.finalScores.innerHTML = '<h3>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</h3>';
                const sortedPlayers = Object.keys(gameState.scores).sort((a, b) => gameState.scores[b] - gameState.scores[a]);
                
                sortedPlayers.forEach(player => {
                    const li = document.createElement('li');
                    li.innerText = `${player}: ${gameState.scores[player]} Ù†Ù‚Ø·Ø©`;
                    if (player === sortedPlayers[0]) li.classList.add('final-winner');
                    elements.finalScores.appendChild(li);
                });
            }
            
            function restartGame() {
                gameState.selectedTopic = null;
                populateTopics();
                validateSetup();
                showScreen('setup-screen');
            }

            // --- Event Listeners Setup ---
            document.body.addEventListener('click', handleAction);
            elements.addPlayerBtn.addEventListener('click', addPlayer);
            elements.playerNameInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') addPlayer(); });
            elements.startGameBtn.addEventListener('click', startGame);
            elements.restartGameBtn.addEventListener('click', restartGame);
            document.getElementById('close-how-to-play-btn').addEventListener('click', () => { playSound('click'); showModal('how-to-play-modal', false); });
            elements.topicSelectionDiv.addEventListener('click', (e) => {
                const card = e.target.closest('.topic-card');
                if (card) { playSound('click'); selectTopic(card); }
            });
            elements.playerList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-player')) {
                    removePlayer(e.target.dataset.player);
                }
            });

            function selectTopic(topicEl) {
                elements.topicSelectionDiv.querySelectorAll('.topic-card').forEach(c => c.classList.remove('selected'));
                topicEl.classList.add('selected');
                gameState.selectedTopic = topicEl.dataset.topic;
                validateSetup();
            }

            // --- Initial Load ---
            populateTopics();
            showScreen('home-screen');
        });
    </script>
</body>
</html>
